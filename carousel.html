<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>실시간 3D 커버플로우 캐러셀 (자동회전)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overscroll-behavior: contain;
            touch-action: pan-y; /* 수직 스크롤은 허용하되, 수평 스와이프는 JS로 제어 */
        }
        .carousel-container {
            position: relative;
            width: 100%;
            height: 350px; /* 높이 조정 */
            perspective: 1200px; /* 원근감 강화 */
            overflow: hidden;
        }
        .carousel-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            /* transform은 JS로 제어 */
        }
        .carousel-item {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            margin: auto;
            width: 220px; /* 아이템 너비 */
            height: 320px; /* 아이템 높이 */
            background-size: cover;
            background-position: center;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            -webkit-box-reflect: below 5px linear-gradient(transparent, transparent, rgba(0,0,0,0.4));
            user-select: none;
            cursor: grab;
            /* transition은 JS로 제어 */
        }
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
            pointer-events: none; /* 이미지에서 드래그 이벤트 방지 */
        }
        .grabbing {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen font-sans overflow-hidden">

    <div class="w-full">
        <h1 class="text-3xl font-bold text-center mb-8 text-white">3D 커버플로우 캐러셀</h1>
        <div id="carousel-container" class="carousel-container">
            <div id="carousel-wrapper" class="carousel-wrapper">
                <!-- Carousel Items -->
                <div class="carousel-item"><img src="https://placehold.co/440x640/7e22ce/ffffff?text=MIDAS" alt="Item 1"></div>
                <div class="carousel-item"><img src="https://placehold.co/440x640/be185d/ffffff?text=VK+Fest" alt="Item 2"></div>
                <div class="carousel-item"><img src="https://placehold.co/440x640/16a34a/ffffff?text=Concert" alt="Item 3"></div>
                <div class="carousel-item"><img src="https://placehold.co/440x640/ca8a04/ffffff?text=Show" alt="Item 4"></div>
                <div class="carousel-item"><img src="https://placehold.co/440x640/0284c7/ffffff?text=Event" alt="Item 5"></div>
                <div class="carousel-item"><img src="https://placehold.co/440x640/4338ca/ffffff?text=Artist" alt="Item 6"></div>
                <div class="carousel-item"><img src="https://placehold.co/440x640/c2410c/ffffff?text=Festival" alt="Item 7"></div>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('carousel-container');
        const wrapper = document.getElementById('carousel-wrapper');
        let items = Array.from(document.querySelectorAll('.carousel-item'));
        
        // --- 변수 선언 ---
        let isDragging = false;
        let startX = 0;
        let currentX = 0;
        let lastX = 0;
        let offsetX = 0;

        let itemWidth = 0;
        const gap = 40; // 아이템 간의 간격
        let itemSpacing = 0;
        
        // --- 자동 회전 및 무한 루프 관련 변수 ---
        let isAutoScrolling = true;
        const autoScrollSpeed = -0.25; // 회전 속도 (음수 = 왼쪽)
        let autoScrollTimeout;
        let totalOriginalItems = items.length;
        const cloneCount = 5; // 양쪽에 복제할 아이템 수 (아이템이 많을수록 좋음)


        function initialize() {
            // --- 무한 루프를 위한 아이템 복제 ---
            // 마지막 아이템들을 복제해서 맨 앞에 추가
            for (let i = 0; i < cloneCount; i++) {
                const clone = items[totalOriginalItems - 1 - (i % totalOriginalItems)].cloneNode(true);
                wrapper.insertBefore(clone, items[0]);
            }
            // 첫 아이템들을 복제해서 맨 뒤에 추가
            for (let i = 0; i < cloneCount; i++) {
                const clone = items[i % totalOriginalItems].cloneNode(true);
                wrapper.appendChild(clone);
            }

            // 복제된 아이템들을 포함하여 배열 업데이트
            items = Array.from(document.querySelectorAll('.carousel-item'));
            itemWidth = items[0].offsetWidth;
            itemSpacing = itemWidth + gap;

            // 초기 위치 설정 (복제된 아이템 뒤, 원본 아이템의 시작점)
            offsetX = -cloneCount * itemSpacing;
            lastX = offsetX;
            
            // 애니메이션 루프 시작
            requestAnimationFrame(animationLoop);
        }

        function getPositionX(event) {
            return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
        }

        function onDragStart(event) {
            isAutoScrolling = false; // 자동 회전 중지
            clearTimeout(autoScrollTimeout); // 자동 회전 재시작 타이머 제거

            isDragging = true;
            startX = getPositionX(event);
            container.classList.add('grabbing');
            items.forEach(item => item.style.transition = 'none');
        }

        function onDrag(event) {
            if (!isDragging) return;
            currentX = getPositionX(event);
            offsetX = lastX + (currentX - startX);
        }

        function onDragEnd() {
            if (!isDragging) return;
            isDragging = false;
            container.classList.remove('grabbing');
            lastX = offsetX;

            // 가장 가까운 아이템으로 스냅
            let targetIndex = Math.round(-offsetX / itemSpacing);
            offsetX = -targetIndex * itemSpacing;
            lastX = offsetX;

            // 스냅 애니메이션 적용
            items.forEach(item => {
                item.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
            });
            
            // 일정 시간 후 자동 회전 다시 시작
            autoScrollTimeout = setTimeout(() => {
                isAutoScrolling = true;
                items.forEach(item => item.style.transition = 'none'); // 부드러운 자동 회전을 위해 transition 제거
            }, 3000); // 3초 후 재시작
        }

        function updatePositions() {
            const containerWidth = container.offsetWidth;
            const center = containerWidth / 2;

            items.forEach((item, i) => {
                const itemCenter = (i * itemSpacing) + (itemWidth / 2) + offsetX;
                const distanceFromCenter = itemCenter - center;
                
                // 중앙으로부터의 거리에 따라 스타일 계산
                const scale = 1 - Math.abs(distanceFromCenter) / (containerWidth * 2);
                const rotationY = (distanceFromCenter / containerWidth) * 45;
                const translateZ = -Math.abs(distanceFromCenter) / 2.5;
                const opacity = 1 - Math.abs(distanceFromCenter) / center;
                const zIndex = totalOriginalItems - Math.floor(Math.abs(distanceFromCenter) / itemSpacing);

                item.style.transform = `translateX(${distanceFromCenter - itemWidth/2}px) translateZ(${translateZ}px) rotateY(${rotationY}deg) scale(${scale})`;
                item.style.opacity = Math.max(0, opacity);
                item.style.zIndex = zIndex;
            });
        }
        
        function animationLoop() {
            if (isAutoScrolling && !isDragging) {
                offsetX += autoScrollSpeed;
                lastX = offsetX;
            }

            // --- 무한 루프를 위한 위치 점프 로직 ---
            const originalContentWidth = totalOriginalItems * itemSpacing;
            const loopPointStart = -cloneCount * itemSpacing;
            const loopPointEnd = -(cloneCount + totalOriginalItems) * itemSpacing;

            if (offsetX <= loopPointEnd) {
                offsetX += originalContentWidth;
                lastX += originalContentWidth;
            }
            if (offsetX >= loopPointStart) {
                offsetX -= originalContentWidth;
                lastX -= originalContentWidth;
            }

            updatePositions();
            requestAnimationFrame(animationLoop);
        }

        // --- 이벤트 리스너 등록 ---
        container.addEventListener('mousedown', onDragStart);
        container.addEventListener('touchstart', onDragStart, { passive: true });
        window.addEventListener('mousemove', onDrag);
        window.addEventListener('touchmove', onDrag, { passive: true });
        window.addEventListener('mouseup', onDragEnd);
        window.addEventListener('touchend', onDragEnd);
        window.addEventListener('mouseleave', onDragEnd);
        
        // --- 초기화 ---
        window.addEventListener('load', initialize);
    </script>

</body>
</html>
